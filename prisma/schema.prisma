generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  Int      @id @default(autoincrement())
  email               String   @unique
  password_hash       String
  first_name          String
  last_name           String
  phone               String?
  profile_picture_url String?
  role                String   @default("user")
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt

  sessions     Session[]
  reset_tokens PasswordResetToken[]

  patient Patient?
  doctor  Doctor?

  messages_sent ChatMessage[]

  @@map("users")
}

model Session {
  id         Int      @id @default(autoincrement())
  user_id    Int
  token      String   @unique
  expires_at DateTime

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model PasswordResetToken {
  id         Int      @id @default(autoincrement())
  user_id    Int
  token      String   @unique
  expires_at DateTime
  created_at DateTime @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
}

model Patient {
  id              Int     @id @default(autoincrement())
  user_id         Int     @unique
  date_of_birth   String?
  gender          String?
  address         String?
  medical_history String?

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  appointments  Appointment[]
  conversations ChatConversation[]

  @@map("patients")
}

model Doctor {
  id               Int      @id @default(autoincrement())
  user_id          Int      @unique
  specialization   String?
  qualification    String?
  experience_years Int?
  bio              String?
  cv_url           String?
  is_approved      Boolean  @default(false)
  updated_at       DateTime @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  appointments  Appointment[]
  conversations ChatConversation[]
  availability  DoctorAvailability[]

  @@map("doctors")
}

model Appointment {
  id               Int      @id @default(autoincrement())
  patient_id       Int
  doctor_id        Int
  appointment_date DateTime
  reason_for_visit String?
  status           String   @default("pending")
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  patient       Patient            @relation(fields: [patient_id], references: [id])
  doctor        Doctor             @relation(fields: [doctor_id], references: [id])
  conversations ChatConversation[]

  @@map("appointments")
}

model ChatConversation {
  id             Int      @id @default(autoincrement())
  patient_id     Int
  doctor_id      Int
  appointment_id Int?
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  patient     Patient       @relation(fields: [patient_id], references: [id])
  doctor      Doctor        @relation(fields: [doctor_id], references: [id])
  appointment Appointment?  @relation(fields: [appointment_id], references: [id])
  messages    ChatMessage[]

  @@map("chat_conversations")
}

model ChatMessage {
  id              Int      @id @default(autoincrement())
  conversation_id Int
  sender_id       Int
  content         String
  created_at      DateTime @default(now())

  conversation ChatConversation @relation(fields: [conversation_id], references: [id], onDelete: Cascade)
  sender       User             @relation(fields: [sender_id], references: [id], onDelete: Cascade)

  @@map("chat_messages")
}

model DoctorAvailability {
  id          Int     @id @default(autoincrement())
  doctor_id   Int
  day_of_week String
  start_time  String
  end_time    String
  break_start String?
  break_end   String?

  doctor Doctor @relation(fields: [doctor_id], references: [id], onDelete: Cascade)

  @@map("doctor_availability")
}
